{"version":3,"sources":["../../../src/lib/lm-studio.ts"],"sourcesContent":["export const CONFIG = {\n    baseUrl: process.env.LM_STUDIO_BASE_URL || \"http://127.0.0.1:1234/v1\",\n    timeoutMs: 25000,\n};\n\nexport async function detectModelCapabilities(baseUrl: string) {\n    try {\n        const res = await fetch(`${baseUrl}/models`, {\n            signal: AbortSignal.timeout(2000),\n            headers: { \"Content-Type\": \"application/json\" }\n        });\n\n        if (!res.ok) throw new Error(`Status ${res.status}`);\n\n        const data = await res.json();\n        // Prefer the first non-embedding model\n        const model = data.data?.find((m: any) => !m.id.includes(\"embedding\"));\n\n        if (!model) return null;\n\n        return {\n            id: model.id,\n            isChat: model.id.toLowerCase().includes(\"instruct\") || model.id.toLowerCase().includes(\"chat\") || model.id.toLowerCase().includes(\"gpt\"),\n        };\n    } catch (error) {\n        console.warn(\"[Capability Detection Failed]\", error);\n        return null;\n    }\n}\n\nexport async function analyzeText(text: string, targetLanguage: string = \"English\") {\n    // 1. Detect Capabilities\n    let modelId = process.env.LM_STUDIO_MODEL;\n    let endpoint = \"chat/completions\";\n\n    if (!modelId) {\n        const caps = await detectModelCapabilities(CONFIG.baseUrl);\n        if (caps) {\n            modelId = caps.id;\n        } else {\n            console.warn(\"Could not detect model, failing over to default.\");\n            modelId = \"local-model\";\n        }\n    }\n\n    // 2. Prepare Payload (Sanitized)\n    const systemPrompt = `You are noCap, a gen-z slang expert.\nYou must analyze the user's message and output the result in ${targetLanguage}.\n\nYour task:\n1. Analyze the user's message.\n2. \"sentence_meaning\": Provide a VIBE-BASED translation in ${targetLanguage}. Capture the emotion and intent.\n3. \"terms\": Identify specific slang phrases. \n   - CRITICAL: Treat multi-word slang as SINGLE units (e.g. \"Oh hell naw\").\n   - Meaning: Explain the usage/context purely in ${targetLanguage}.\n   - Example: A natural usage example (keep the slang in English, but you can translate the rest of the sentence to ${targetLanguage} if appropriate).\n4. Output STRICTLY a valid JSON object.\n\nOutput Language: ${targetLanguage}\nOutput Language: ${targetLanguage}\nOutput Language: ${targetLanguage}\n\nStructure:\n{\n  \"sentence_meaning\": \"The overall translation/vibe written in ${targetLanguage}.\",\n  \"terms\": [\n    {\n      \"term\": \"phrase or word\",\n      \"meaning\": \"definition written in ${targetLanguage}\",\n      \"example\": \"usage example\"\n    }\n  ]\n}`;\n\n    const payload = {\n        model: modelId,\n        messages: [\n            { role: \"system\", content: systemPrompt },\n            { role: \"user\", content: `${text}\\n\\nIMPORTANT: Provide all definitions and translations in ${targetLanguage}.` }\n        ],\n        temperature: 0.3, // Lower temperature for more consistent JSON\n        stream: false\n    };\n\n    console.log(`[Request] Sending to ${CONFIG.baseUrl}/${endpoint} with model ${modelId} | Language: ${targetLanguage}`);\n\n    // 3. Send Request\n    let response = await fetch(`${CONFIG.baseUrl}/${endpoint}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n        signal: AbortSignal.timeout(CONFIG.timeoutMs)\n    });\n\n    // 4. Fallback for legacy endpoint\n    if (!response.ok && (response.status === 404 || response.status === 400)) {\n        console.warn(`[First Attempt Failed] ${response.status}. Retrying with legacy completion endpoint...`);\n        const legacyPayload = {\n            model: modelId,\n            prompt: `${systemPrompt}\\n\\nUser: ${text}\\n\\nIMPORTANT: Provide all definitions and translations in ${targetLanguage}.\\n\\nResponse:`,\n            temperature: 0.3,\n            max_tokens: 500\n        };\n        response = await fetch(`${CONFIG.baseUrl}/completions`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify(legacyPayload),\n            signal: AbortSignal.timeout(CONFIG.timeoutMs)\n        });\n    }\n\n    if (!response.ok) {\n        throw new Error(`LM Studio error: ${response.statusText}`);\n    }\n\n    // 5. Parse Response\n    const data = await response.json();\n    let reply = \"\";\n\n    if (data.choices?.[0]?.message?.content) {\n        reply = data.choices[0].message.content;\n    } else if (data.choices?.[0]?.text) {\n        reply = data.choices[0].text;\n    } else {\n        reply = \"No response generated.\";\n    }\n\n    return reply;\n}\n"],"names":[],"mappings":"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"}